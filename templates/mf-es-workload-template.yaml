# Â© Copyright 2018 Micro Focus or one of its affiliates
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
AWSTemplateFormatVersion: 2010-09-09
Description:
  "This template deploys a Micro Focus Enterprise Server reference architecture
  including optional Remote Fileshare and SQLServer Database services into an
  existing VPC. **WARNING** This template creates EC2 instances and related
  resources. You will be billed for the AWS resources used if you create a stack
  from this template. License: Apache 2.0 (Please do not remove) Sept,05,2018.
  Micro Focus Enterprise Server is licensed separately, please review the terms
  and conditions here (https://www.microfocus.com/about/legal/) for further
  details. (qs-1p6hinfi)"
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Software License Agreement
        Parameters:
          - LicenseAgreement
          - ESLicenseFilename
      - Label:
          default: Network Configuration
        Parameters:
          - VPCID
          - PublicSubnet1ID
          - PublicSubnet2ID
          - PrivateSubnet1AID
          - PrivateSubnet2AID
          - AvailabilityZones
      - Label:
          default: Microsoft Active Directory Configuration
        Parameters:
          - DirectoryServiceID
          - DomainDNSName
          - DomainNetBIOSName
          - DomainMemberSGID
          - DomainAdminPassword
          - DomainAdminPasswordConfirm
      - Label:
          default: Remote Desktop Gateway Configuration
        Parameters:
          - RDGWAccessSGID
      - Label:
          default: Linux Bastion Configuration
        Parameters:
          - BastionAccessSGID
      - Label:
          default: Enterprise Server Configuration
        Parameters:
          - OS
          - ESInstanceType
          - LoadRunnerInstanceType
          - MaxNumberOfESInstances
          - MetricsNamespace
          - KeyPairName
          - RegionsPerInstance
          - AdditionalESStorageinGiB
          - ESCWLogGroupRetentionInDays
          - MFDSServiceAccountName
          - MFDSServiceAccountPassword
          - MFDSServiceAccountPasswordConfirm
          - OperatorEmail
          - ESS3BucketName
          - ESResourceNamePrefix
      - Label:
          default: PAC Configuration
        Parameters:
          - PACDBInstanceClass
          - PACDBMasterUsername
          - PACDBMasterUserPassword
          - PACDBMasterUserPasswordConfirm
      - Label:
          default: Enterprise Server Demo Apps Configuration
        Parameters:
          - ESDemoUserPassword
          - ESDemoUserPasswordConfirm
          - DemoAppsIngressCIDR
      - Label:
          default: AWS Quick Start Configuration
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
    ParameterLabels:
      AdditionalESStorageinGiB:
        default: Additional Enterprise Server instance storage
      AvailabilityZones:
        default: Availability Zones
      BastionAccessSGID:
        default: Bastion Security Group ID
      DemoAppsIngressCIDR:
        default: Allowed Demo Apps external access CIDR
      DirectoryServiceID:
        default: Directory Service ID
      DomainAdminPassword:
        default: Domain Admin account password
      DomainAdminPasswordConfirm:
        default: Re-enter the domain Admin account password
      DomainDNSName:
        default: Domain DNS name
      DomainMemberSGID:
        default: Domain member Security Group ID
      DomainNetBIOSName:
        default: Domain NetBIOS name
      ESCWLogGroupRetentionInDays:
        default: Amazon CloudWatch log retention
      ESDemoUserPassword:
        default: Enterprise Server Demo User password
      ESDemoUserPasswordConfirm:
        default: Re-enter the Enterprise Server Demo User password
      OS:
        default: Enterprise Server instance(s) OS type
      ESInstanceType:
        default: Enterprise Server instance type
      ESLicenseFilename:
        default: Enterprise Server license filename
      ESResourceNamePrefix:
        default: Resource 'Name' prefix
      ESS3BucketName:
        default: Enterprise Server S3 bucket name
      KeyPairName:
        default: Key pair name
      LicenseAgreement:
        default: License agreement
      LoadRunnerInstanceType:
        default: LoadRunner instance type
      MaxNumberOfESInstances:
        default: Maximum number of Enterprise Server instances to run simultaneously
      MetricsNamespace:
        default: Namespace for the Enterprise Server custom metrics
      MFDSServiceAccountName:
        default: Micro Focus Directory Server service domain account name
      MFDSServiceAccountPassword:
        default: Micro Focus Directory Server service account password
      MFDSServiceAccountPasswordConfirm:
        default: Re-enter the Micro Focus Directory Server service account password
      OperatorEmail:
        default: Operator email address
      PACDBInstanceClass:
        default: PAC database instance class
      PACDBMasterUsername: 
        default: PAC database Master username
      PACDBMasterUserPassword:
        default: PAC database Master password
      PACDBMasterUserPasswordConfirm:
        default: Re-enter the PAC database Master password
      PrivateSubnet1AID:
        default: Private Subnet 1A ID
      PrivateSubnet2AID:
        default: Private Subnet 2A ID
      PublicSubnet1ID:
        default: Public Subnet 1 ID
      PublicSubnet2ID:
        default: Public Subnet 2 ID
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      RDGWAccessSGID:
        default: RD Gateway Security Group ID
      RegionsPerInstance:
        default: Number of Enterprise Server regions per instance
      VPCID:
        default: VPC ID
Parameters:
  AdditionalESStorageinGiB:
    Type: Number
    Description: >-
      Additional EBS storage capacity in gibibytes (GiBs) added to each
      Enterprise Server instance. Enter 0-16384 GiB.
    MinValue: 0
    MaxValue: 16384
    Default: 100
  AvailabilityZones:
    Description: >-
      The list of Availability Zones to use for the subnets in the VPC. The
      Quick Start uses two Availability Zones from your list and preserves the
      logical order you specify.
    Type: 'List<AWS::EC2::AvailabilityZone::Name>'
  BastionAccessSGID:
    Type: 'AWS::EC2::SecurityGroup::Id'
    Description: >-
      The security group ID for access from the Bastion host.
  DemoAppsIngressCIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: The CIDR block parameter must be in the form x.x.x.x/x.
    Description: >-
      The allowed CIDR block for external access to the demo apps. The CIDR block
      parameter must be in the form x.x.x.x/x.
    Type: String
  DirectoryServiceID:
    Type: String
    Description: >-
      The ID of the AWS Managed Microsoft AD directory in which you want to
      deploy.
  DomainAdminPassword:
    AllowedPattern: >-
      (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Description: >-
      The password for the domain Admin account. Must be at least 8 characters
      containing letters, numbers, and symbols.
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String
  DomainAdminPasswordConfirm:
    AllowedPattern: >-
      (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Description: >-
      Confirm the password for the domain Admin account. Must be at least 8
      characters containing letters, numbers, and symbols.
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String
  DomainDNSName:
    AllowedPattern: '[a-zA-Z0-9\-]+\..+'
    Default: example.com
    Description: >-
      The fully qualified domain name (FQDN), e.g., example.com. Must be 2-255
      characters.
    MaxLength: '255'
    MinLength: '2'
    Type: String
  DomainMemberSGID:
    Description: >-
      The ID of the Domain Member Security Group (e.g., sg-7f16e910).
    Type: 'AWS::EC2::SecurityGroup::Id'
  DomainNetBIOSName:
    AllowedPattern: '[a-zA-Z0-9\-]+'
    Default: example
    Description: >-
      The NetBIOS name of the domain (up to 15 characters) for users of
      earlier versions of Microsoft Windows, e.g., example.
    MaxLength: '15'
    Type: String
  ESCWLogGroupRetentionInDays:
    Default: 7
    Description: The number of days that log events are kept in Amazon CloudWatch Logs.
    Type: Number
  ESDemoUserPassword:
    AllowedPattern: >-
      ^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,32}$
    Description: >-
      The password for the ESDemoUser. Must contain 8 to 32 characters, at least
      one uppercase letter, one lowercase letter, one number and one special
      character.
    ConstraintDescription: >-
      Must contain 8 to 32 characters, at least one uppercase letter, one
      lowercase letter, one number and one special character.
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String
  ESDemoUserPasswordConfirm:
    AllowedPattern: >-
      ^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,32}$
    Description: >-
      Confirm the password for the ESDemoUser. Must contain 8 to 32 characters,
      at least one uppercase letter, one lowercase letter, one number and
      one special character.
    ConstraintDescription: >-
      Must contain 8 to 32 characters, at least one uppercase letter, one
      lowercase letter, one number and one special character.
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String
  LoadRunnerInstanceType:
    AllowedValues:
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
    Description: The type of Load Runner instance.
    Default: c5.large
    Type: String
  OS:
    AllowedValues:
      - Windows
      - Red Hat Enterprise Linux
    Description: The operating system type for the Enterprise Server instance(s).
    Default: Windows
    Type: String
  PACDBInstanceClass:
    AllowedValues:
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r2.8xlarge
    Description: The type of Amazon RDS DB instance.
    Default: db.r4.large
    Type: String
  PACDBMasterUsername:
    Description: >-
      Specify an alphanumeric string that defines the login ID for the master
      user in the PAC database. Master user name must start with a letter. Must contain 1 to 64
      alphanumeric characters.
    AllowedPattern: >-
      ^[a-zA-Z][a-zA-Z0-9]{1,64}$
    ConstraintDescription: >-
      Must start with a letter. Must contain 1 to 64 alphanumeric characters.
    Default: DBAdmin
    Type: String
  PACDBMasterUserPassword:
    AllowedPattern: >-
      ^((?![\/"@])[^\x00-\x1F\x80-\x9F]){8,}$
    ConstraintDescription: >-
      Must be at least eight characters long, as in "mypassword". Can be any
      printable ASCII character except "/", """, or "@".
    Description: >-
      The password for the DB master user in the PAC database. Must be at least eight characters
      long, as in "mypassword". Can be any printable ASCII character except
      "/", """, or "@".
    Type: String
    NoEcho: true
  PACDBMasterUserPasswordConfirm:
    AllowedPattern: >-
      ^((?![\/"@])[^\x00-\x1F\x80-\x9F]){8,}$
    ConstraintDescription: >-
      Must be at least eight characters long, as in "mypassword". Can be any
      printable ASCII character except "/", """, or "@".
    Description: >-
      Confirm the password for the DB master user in the PAC database. Must be at least eight
      characters long, as in "mypassword". Can be any printable ASCII character
      except "/", """, or "@".
    Type: String
    NoEcho: true
  ESInstanceType:
    AllowedValues:
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
    Description: The type of Enterprise Server instance.
    Default: c5.large
    Type: String
  ESLicenseFilename:
    Description: >-
      Place the license file obtained from Micro Focus in the S3 bucket folder:
      s3://<Enterprise Server S3 bucket name>/license/
    Type: String
  ESResourceNamePrefix:
    Default: 'AWS::StackName'
    Description: >-
      Used to prefix resource 'Name' tags. Leave empty for no prefix.
      Otherwise, use 'AWS::StackName' or a value such as the parent stacks
      name.
    Type: String
  ESS3BucketName:
    AllowedPattern: '^[a-z0-9][a-z0-9-.]*$'
    Description: >-
      The name of the existing S3 bucket used to store/retrieve objects specific
      to this stack. A system integrator extending this Quick Start should use
      this bucket to store or retrieve items needed. This string can include
      numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot
      start or end with a hyphen (-).
    Type: String
  KeyPairName:
    Description: >-
      The name of an existing EC2 key pair. All instances will launch with this key pair.
    Type: 'AWS::EC2::KeyPair::KeyName'
  LicenseAgreement:
    Description: >-
      I have read and agree to the license terms for Micro Focus Enterprise
      Server
      (https://www.microfocus.com/documentation/enterprise-developer/ed-latest/ES-WIN/GUID-0562B3C9-2271-4CE8-AF64-93DE4940077F.html).
    Type: String
    Default: '-'
    AllowedValues:
      - I agree
      - '-'
    ConstraintDescription: Must answer 'I agree'.
  MaxNumberOfESInstances:
    Default: 3
    MinValue: 3
    MaxValue: 10
    Description: >-
      The maximum capacity (3-10) for the Enterprise Server Auto Scaling group.
    Type: Number
  MetricsNamespace:
    Type: String
    AllowedPattern: '[a-zA-Z0-9\.\-_\/#:]*'
    Default: Custom
    Description: >-
      The namespace must be 1-256 characters. Possible characters are: alphanumeric
      characters (0-9A-Za-z), period (.), hyphen (-), underscore (_),
      forward slash (/), hash (#), and colon (:).
    MaxLength: '256'
    MinLength: '1'
  MFDSServiceAccountName:
    Type: String
    AllowedPattern: '[a-zA-Z0-9]*'
    Default: 'MFDSServiceAccount'
    Description: >-
      The existing domain account name under which the service will run. If left as
      default, a domain account 'MFDSServiceAccount' is created. The name must be
      5-25 characters.
    MaxLength: '25'
    MinLength: '5'
  MFDSServiceAccountPassword:
    Type: String
    AllowedPattern: >-
      (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Description: >-
      Enter a password for MFDSServiceAccount. Must be at least 8 characters
      containing letters, numbers, and symbols.
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
  MFDSServiceAccountPasswordConfirm:
    AllowedPattern: >-
      (?=^.{6,255}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*
    Description: >-
      Confirm the password for MFDSServiceAccount. Must be at least 8 characters
      containing letters, numbers, and symbols.
    MaxLength: '32'
    MinLength: '8'
    NoEcho: true
    Type: String
  OperatorEmail:
    AllowedPattern: >-
      (?i)^None$|([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)
    ConstraintDescription: Must be a valid email address.
    Description: >-
      (optional) The email address that notifications are sent to (e.g.,
      database, VM failures, etc.).
    Type: String
    Default: None
  PrivateSubnet1AID:
    Description: >-
      The ID of private subnet 1A in Availability Zone 1 (e.g.,
      subnet-a0246dcd).
    Type: 'AWS::EC2::Subnet::Id'
  PrivateSubnet2AID:
    Description: >-
      The ID of private subnet 2A in Availability Zone 2 (e.g.,
      subnet-01a43dc1ca1fa7f9b).
    Type: 'AWS::EC2::Subnet::Id'
  PublicSubnet1ID:
    Description: >-
      The ID of public subnet 1 in Availability Zone 1 for the Elastic Load
      Balancing (ELB) load balancer (e.g., subnet-9bc642ac).
    Type: 'AWS::EC2::Subnet::Id'
  PublicSubnet2ID:
    Description: >-
      The ID of public subnet 2 in Availability Zone 2 for the Elastic Load
      Balancing (ELB) load balancer (e.g., subnet-e3246d8e).
    Type: 'AWS::EC2::Subnet::Id'
  QSS3BucketName:
    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
    ConstraintDescription: >-
      The bucket name can include numbers, lowercase letters, uppercase
      letters, and hyphens (-), but should not start or end with a hyphen.
    Default: aws-quickstart
    Description: >-
      The S3 bucket you have created for your copy of Quick Start assets, if
      you decide to customize or extend the Quick Start for your own use. The
      bucket name can include numbers, lowercase letters, uppercase letters,
      and hyphens (-), but should not start or end with a hyphen.
    Type: String
  QSS3BucketRegion:
    Default: 'us-east-1'
    Description: 'The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value.'
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: '^[0-9a-zA-Z-/]*$'
    ConstraintDescription: >-
      Quick Start key prefix can include numbers, lowercase letters, uppercase
      letters, hyphens (-), and forward slash (/).
    Default: quickstart-microfocus-amc-es/
    Description: >-
      The S3 key name prefix used to simulate a folder for your copy of Quick
      Start assets, if you decide to customize or extend the Quick Start for
      your own use. This prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slashes (/).
    Type: String
  RDGWAccessSGID:
    Type: 'AWS::EC2::SecurityGroup::Id'
    Description: >-
      The security group ID for access from the Remote Desktop Gateway.
  RegionsPerInstance:
    ConstraintDescription: Must be between 1 and 10 regions per instance.
    Description: >-
      The number of regions per Enterprise Server instance. Must be between 1 and
      10 regions per instance.
    Default: 1
    MaxValue: 10
    MinValue: 1
    Type: Number
  VPCID:
    Description: ID of your existing VPC for deployment.
    Type: 'AWS::EC2::VPC::Id'
Rules:
  DomainAdminPasswordsMatchRule:
    Assertions:
      - Assert: !Equals
          - !Ref DomainAdminPassword
          - !Ref DomainAdminPasswordConfirm
        AssertDescription: Domain Admin account password values do not match.
  ESDemoUserPasswordMatchRule:
    Assertions:
      - Assert: !Equals
          - !Ref ESDemoUserPassword
          - !Ref ESDemoUserPasswordConfirm
        AssertDescription: Enterprise Server Demo user password values do not match.
  PACDBMasterUserPasswordMatchRule:
    Assertions:
      - Assert: !Equals
          - !Ref PACDBMasterUserPassword
          - !Ref PACDBMasterUserPasswordConfirm
        AssertDescription: The PAC database Master password values do not match.
  KeyPairsNotEmpty:
    Assertions:
      - Assert: !Not
          - 'Fn::EachMemberEquals':
              - 'Fn::RefAll': 'AWS::EC2::KeyPair::KeyName'
              - ''
        AssertDescription: All key pair parameters must not be empty.
  LicenseAgreementRule:
    Assertions:
      - Assert:
          'Fn::Contains':
            - - I agree
            - !Ref LicenseAgreement
        AssertDescription: User must agree to the terms of the license agreement.
  MFDSServiceAccountPasswordsMatchRule:
    Assertions:
      - Assert: !Equals
          - !Ref MFDSServiceAccountPassword
          - !Ref MFDSServiceAccountPasswordConfirm
        AssertDescription: The Micro Focus Directory Server, Service Account password values do not match.
  ESSupportedRegionRule:
    Assertions:
      - Assert: !Contains
          - - us-east-2          # US East (Ohio)
            - us-east-1          # US East (N. Virginia)
            - us-west-1          # US West (N. California)
            - us-west-2          # US West (Oregon)
            #- ap-east-1          # Asia Pacific (Hong Kong) --> MFES not available
            - ap-south-1         # Asia Pacific (Mumbai)
            # - ap-northeast-3     # Asia Pacific (Osaka-Local) --> Osaka-Local not supported
            - ap-northeast-2     # Asia Pacific (Seoul)
            - ap-southeast-1     # Asia Pacific (Singapore)
            - ap-southeast-2     # Asia Pacific (Sydney)
            - ap-northeast-1     # Asia Pacific (Tokyo)
            - ca-central-1       # Canada (Central)
            # - cn-north-1         # China (Beijing) --> MFES not available
            # - cn-northwest-1     # China (Ningxia) --> MFES not available
            - eu-central-1       # Europe (Frankfurt)
            - eu-west-1          # Europe (Ireland)
            - eu-west-2          # Europe (London)
            - eu-west-3          # Europe (Paris)
            - eu-north-1         # Europe (Stockholm)
            #- me-south-1         # Middle East (Bahrain) --> MFES not available
            - sa-east-1          # South America (Sao Paulo)
            # - us-gov-east-1      # AWS GovCloud (US-East) --> GovCloud not supported
            # - us-gov-west-1      # AWS GovCloud (US-West) --> GovCloud not supported 
          - !Ref AWS::Region
        AssertDescription: Micro Focus is not currently supporting this Quick Start in 
          the chosen region. Please contact Micro Focus or launch into a different region.
Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
  GovCloudCondition: !Equals
    - !Ref 'AWS::Region'
    - us-gov-west-1
  HaveOperatorEmail: !Not
    - !Equals
      - !Ref OperatorEmail
      - None
  NamePrefixIsAWSStackname: !Equals
    - !Ref ESResourceNamePrefix
    - 'AWS::StackName'
  NamePrefixIsUndefined: !Equals
    - !Ref ESResourceNamePrefix
    - ''
  OSRedhat: !Equals
    - !Ref OS
    - 'Red Hat Enterprise Linux'
  OSWindows: !Equals
    - !Ref OS
    - 'Windows'
Resources:
  EMailNotificationTopic:
    Type: 'AWS::SNS::Topic'
    Condition: HaveOperatorEmail
    Properties:
      Subscription:
        - Endpoint: !Ref OperatorEmail
          Protocol: email
  ESCWLogGroup:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Sub
        - '${StackNamePrefix}-LogGroup'
        - StackNamePrefix: !If
            - NamePrefixIsUndefined
            - '${AWS::StackName}-'
            - !If
              - NamePrefixIsAWSStackname
              - !Sub '${AWS::StackName}-'
              - !Sub '${ESResourceNamePrefix}-'
      RetentionInDays: !Ref ESCWLogGroupRetentionInDays
  AuroraServerStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/mf-db-aurora-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        DBInstanceClass: !Ref PACDBInstanceClass
        DBMasterUsername: !Ref PACDBMasterUsername
        DBMasterUserPassword: !Ref PACDBMasterUserPassword
        DirectoryServiceID: !Ref DirectoryServiceID
        ESClientAccessSGID: !Ref ESInstance1ClientAccessSecurityGroup
        ESResourceNamePrefix: !Ref ESResourceNamePrefix
        NotificationARN: !If
          - HaveOperatorEmail
          - !Ref EMailNotificationTopic
          - !Ref 'AWS::NoValue'
        PrivateSubnet1AID: !Ref PrivateSubnet1AID
        PrivateSubnet2AID: !Ref PrivateSubnet2AID
        VPCID: !Ref VPCID
  ESInstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
      Path: /
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM'
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - 's3:GetObject'
                Effect: Allow
                Resource:
                  - !Sub
                    - 'arn:${partition}:s3:::${QSS3BucketName}'
                    - partition: !If
                        - GovCloudCondition
                        - aws-us-gov
                        - aws
                  - !Sub
                    - 'arn:${partition}:s3:::${QSS3BucketName}/${QSS3KeyPrefix}*'
                    - partition: !If
                        - GovCloudCondition
                        - aws-us-gov
                        - aws
            Version: 2012-10-17
          PolicyName: aws-quick-start-s3-policy
        - PolicyDocument:
            Statement:
              - Action:
                  - 's3:*'
                Effect: Allow
                Resource:
                  - !Sub
                    - 'arn:${partition}:s3:::${ESS3BucketName}'
                    - partition: !If
                        - GovCloudCondition
                        - aws-us-gov
                        - aws
                  - !Sub
                    - 'arn:${partition}:s3:::${ESS3BucketName}/*'
                    - partition: !If
                        - GovCloudCondition
                        - aws-us-gov
                        - aws
              - Action:
                  - 'ds:Describe*'
                Effect: Allow
                Resource: '*'
          PolicyName: ESInstancePolicy
  ESInstanceRoleProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref ESInstanceRole
  ESInstance1ClientAccessSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        Security Group for (client/application) ingress traffic into Enterprise
        Server 1
      VpcId: !Ref VPCID
      SecurityGroupIngress:
        - Description: >-
            Allows RDP access into the instance from the Remote Desktop Gateway
            (for administrative purposes)
          IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          SourceSecurityGroupId: !Ref RDGWAccessSGID
        - Description: >-
            Allows access to the Enterprise Server Admin portal from the Remote
            Desktop Gateway instances
          IpProtocol: tcp
          FromPort: 86
          ToPort: 86
          SourceSecurityGroupId: !Ref RDGWAccessSGID
        - !If
          - OSRedhat
          - Description: >-
              Allows access to the Enterprise Server Admin portal from the Bastion
              hosts
            IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            SourceSecurityGroupId: !Ref BastionAccessSGID
          - !Ref 'AWS::NoValue'
        - Description: Allow ICMP Destination Unreachable to aid MTU Path Discovery
          IpProtocol: icmp
          FromPort: 3
          ToPort: 4
          CidrIp: !Ref DemoAppsIngressCIDR
        - Description: PAC Bank Demo Application TN3270 Listener Ingress
          IpProtocol: tcp
          FromPort: 5557
          ToPort: 5557
          CidrIp: !Ref DemoAppsIngressCIDR
  ElasticacheSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VPCID
      GroupDescription: "Elasticache Security Group"
      SecurityGroupIngress:
        -
          IpProtocol: "tcp"
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref ESInstance1ClientAccessSecurityGroup
  ElasticacheSubnetGroup1:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: "Elasticache Subnet Group"
      SubnetIds: [!Ref PrivateSubnet1AID]
  Elasticache1:
    Type: AWS::ElastiCache::CacheCluster
    Properties:
      AutoMinorVersionUpgrade: true
      CacheSubnetGroupName: !Ref ElasticacheSubnetGroup1
      Engine: "redis"
      CacheNodeType: "cache.t2.micro"
      NumCacheNodes: 1
      VpcSecurityGroupIds: [!Ref ElasticacheSecurityGroup,]
  BootstrapStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/mf-es-bootstrap-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        PACDBMasterUsername: !Ref PACDBMasterUsername
        PACDBMasterUserPassword: !Ref PACDBMasterUserPassword
        DomainAdminPassword: !Ref DomainAdminPassword
        DomainDNSName: !Ref DomainDNSName
        DomainMemberSGID: !Ref DomainMemberSGID
        DomainNetBIOSName: !Ref DomainNetBIOSName
        ESDemoUserPassword: !Ref ESDemoUserPassword
        ESClientAccessSGID: !Ref ESInstance1ClientAccessSecurityGroup
        ESPACDatabaseEndpointAddress: !GetAtt AuroraServerStack.Outputs.ESPACDatabaseEndpointAddress
        ESS3BucketName: !Ref ESS3BucketName
        KeyPairName: !Ref KeyPairName
        MFDSServiceAccountName: !Ref MFDSServiceAccountName
        MFDSServiceAccountPassword: !Ref MFDSServiceAccountPassword
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        RedisEndPoint: !GetAtt Elasticache1.RedisEndpoint.Address
        SubnetID: !Ref PrivateSubnet1AID
  ESCWAStack:
    Type: 'AWS::CloudFormation::Stack'
    DependsOn:
      - BootstrapStack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/mf-escwa-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        DomainAdminPassword: !Ref DomainAdminPassword
        DomainDNSName: !Ref DomainDNSName
        DomainMemberSGID: !Ref DomainMemberSGID
        DomainNetBIOSName: !Ref DomainNetBIOSName
        EMailNotificationTopic: !If
          - HaveOperatorEmail
          - !Ref EMailNotificationTopic
          - !Ref 'AWS::NoValue'
        ESClientAccessSGID: !Ref ESInstance1ClientAccessSecurityGroup
        ESCWLogGroup: !Ref ESCWLogGroup
        ESCWAInstanceType: !Ref ESInstanceType
        ESLicenseFilename: !Ref ESLicenseFilename
        ESS3BucketName: !Ref ESS3BucketName
        KeyPairName: !Ref KeyPairName
        LicenseAgreement: !Ref LicenseAgreement
        MetricsNamespace: !Ref MetricsNamespace
        MFDSServiceAccountName: !Ref MFDSServiceAccountName
        MFDSServiceAccountPassword: !Ref MFDSServiceAccountPassword
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        SubnetID: !Ref PrivateSubnet1AID
  ESInstanceRedHatAutoScalingStack:
    Condition: OSRedhat
    Type: 'AWS::CloudFormation::Stack'
    DependsOn:
      - ESCWAStack
      - BootstrapStack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/mf-es-redhat-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        DomainAdminPassword: !Ref DomainAdminPassword
        DomainDNSName: !Ref DomainDNSName
        DomainMemberSGID: !Ref DomainMemberSGID
        EMailNotificationTopic: !If
          - HaveOperatorEmail
          - !Ref EMailNotificationTopic
          - !Ref 'AWS::NoValue'
        ESClientAccessSGID: !Ref ESInstance1ClientAccessSecurityGroup
        ESInstanceType: !Ref ESInstanceType
        ESLicenseFilename: !Ref ESLicenseFilename
        ESS3BucketName: !Ref ESS3BucketName
        AdditionalESStorageinGiB: !Ref AdditionalESStorageinGiB
        KeyPairName: !Ref KeyPairName
        LicenseAgreement: !Ref LicenseAgreement
        MaxNumberOfESInstances: !Ref MaxNumberOfESInstances
        MetricsNamespace: !Ref MetricsNamespace
        PACDBMasterUserPassword: !Ref PACDBMasterUserPassword
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        RegionsPerInstance: !Ref RegionsPerInstance
        PrivateSubnet1AID: !Ref PrivateSubnet1AID
        PrivateSubnet2AID: !Ref PrivateSubnet2AID
        TargetGroup: !Ref PACDemoApp3270AppsLoadBalancerTargetGroup
  ESInstanceWinAutoScalingStack:
    Condition: OSWindows
    Type: 'AWS::CloudFormation::Stack'
    DependsOn:
      - ESCWAStack
      - BootstrapStack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/mf-es-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        DomainAdminPassword: !Ref DomainAdminPassword
        DomainDNSName: !Ref DomainDNSName
        DomainMemberSGID: !Ref DomainMemberSGID
        DomainNetBIOSName: !Ref DomainNetBIOSName
        EMailNotificationTopic: !If
          - HaveOperatorEmail
          - !Ref EMailNotificationTopic
          - !Ref 'AWS::NoValue'
        ESClientAccessSGID: !Ref ESInstance1ClientAccessSecurityGroup
        ESCWLogGroup: !Ref ESCWLogGroup
        ESInstanceType: !Ref ESInstanceType
        ESLicenseFilename: !Ref ESLicenseFilename
        ESS3BucketName: !Ref ESS3BucketName
        AdditionalESStorageinGiB: !Ref AdditionalESStorageinGiB
        KeyPairName: !Ref KeyPairName
        LicenseAgreement: !Ref LicenseAgreement
        MaxNumberOfESInstances: !Ref MaxNumberOfESInstances
        MetricsNamespace: !Ref MetricsNamespace
        MFDSServiceAccountName: !Ref MFDSServiceAccountName
        MFDSServiceAccountPassword: !Ref MFDSServiceAccountPassword
        PACDBMasterUserPassword: !Ref PACDBMasterUserPassword
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        RegionsPerInstance: !Ref RegionsPerInstance
        PrivateSubnet1AID: !Ref PrivateSubnet1AID
        PrivateSubnet2AID: !Ref PrivateSubnet2AID
        TargetGroup: !Ref PACDemoApp3270AppsLoadBalancerTargetGroup
  ESDemoAppsPublicNetworkLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      IpAddressType: ipv4
      LoadBalancerAttributes:
        - Key: load_balancing.cross_zone.enabled
          Value: 'true'
      Scheme: internet-facing
      Subnets:
        - !Ref PublicSubnet1ID
        - !Ref PublicSubnet2ID
      Tags:
        - Key: Name
          Value: !Sub
            - '${StackNamePrefix}ESPublicNetworkLoadBalancer'
            - StackNamePrefix: !If
                - NamePrefixIsUndefined
                - ''
                - !If
                  - NamePrefixIsAWSStackname
                  - !Sub '${AWS::StackName}-'
                  - !Sub '${ESResourceNamePrefix}-'
      Type: network
  PACDemoApp3270AppsLoadBalancerTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckPort: "5557"
      HealthCheckProtocol: TCP
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 3
      Port: 5557
      Protocol: TCP
      Tags:
        - Key: Name
          Value: !Sub
            - '${StackNamePrefix}SQLDemoApp3270'
            - StackNamePrefix: !If
                - NamePrefixIsUndefined
                - ''
                - !If
                  - NamePrefixIsAWSStackname
                  - !Sub '${AWS::StackName}-'
                  - !Sub '${ESResourceNamePrefix}-'
      TargetType: instance
      UnhealthyThresholdCount: 3
      VpcId: !Ref VPCID
  PACDemoApp3270AppsLoadBalancerListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref PACDemoApp3270AppsLoadBalancerTargetGroup
      LoadBalancerArn: !Ref ESDemoAppsPublicNetworkLoadBalancer
      Port: 5557
      Protocol: TCP
  LoadRunnerStack:
    Type: 'AWS::CloudFormation::Stack'
    DependsOn:
      - BootstrapStack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/mf-loadrunner-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref AvailabilityZones
        DomainAdminPassword: !Ref DomainAdminPassword
        DomainDNSName: !Ref DomainDNSName
        DomainMemberSGID: !Ref DomainMemberSGID
        DomainNetBIOSName: !Ref DomainNetBIOSName
        EMailNotificationTopic: !If
          - HaveOperatorEmail
          - !Ref EMailNotificationTopic
          - !Ref 'AWS::NoValue'
        ESClientAccessSGID: !Ref ESInstance1ClientAccessSecurityGroup
        ESCWLogGroup: !Ref ESCWLogGroup
        ESS3BucketName: !Ref ESS3BucketName
        KeyPairName: !Ref KeyPairName
        LoadBalancerDNSName: !GetAtt ESDemoAppsPublicNetworkLoadBalancer.DNSName
        LoadRunnerInstanceType: !Ref LoadRunnerInstanceType
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        SubnetID: !Ref PrivateSubnet1AID
Outputs:
  ESDemoAppsPublicNetworkLoadBalancer:
    Description: The DNS name for the load balancer.
    Value: !GetAtt ESDemoAppsPublicNetworkLoadBalancer.DNSName